<!DOCTYPE html>
<html lang="en">
{% include 'header.html' %}
<head>
  
</head>
<body>

<!-- Error Modal for displaying validation messages -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="errorModalLabel">Validation Error</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="errorModalBody">
                {{ error_message }}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mt-4">
        <h4>RO Dashboard</h4>
    </div>

    <form method="POST" action="{{ url_for('ro_dashboard') }}">
        <div class="table-container mt-4">
            <table class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th>S.No</th>
                        <th>Polling Station Name</th>
                        <th>9AM</th>
                        <th>9AM%</th>
                        <th>11AM</th>
                        <th>11AM%</th>
                        <th>1PM</th>
                        <th>1PM%</th>
                        <th>3PM</th>
                        <th>3PM%</th>
                        <th>5PM</th>
                        <th>5PM%</th>
                        <th>Closing</th>
                        <th>Closing%</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ps in polling_stations %}
                    <tr data-ps-uid="{{ ps['ps_uid'] }}">
                        <td>{{ loop.index }}</td>
                        <td>{{ ps['NAME'] }}</td>
                        {% for slot in ['TIME_9AM', 'TIME_11AM', 'TIME_01PM', 'TIME_03PM', 'TIME_05PM', 'CLOSE'] %}
                            <td>
                                <input type="number" 
                                       name="voting_count_{{ ps['ps_uid'] }}_{{ slot }}" 
                                       class="form-control form-control-sm" 
                                       value="{{ ps[slot] | default(0) }}" 
                                       min="0"
                                       {% if not editable_slots.get(slot) %}disabled{% endif %}>
                            </td>
                            <td>
                                {% if ps['total_voter'] %}
                                    {{ ((ps[slot] / ps['total_voter']) * 100) | round(2) }}%
                                {% else %}
                                    0%
                                {% endif %}
                            </td>
                        {% endfor %}
                        <td>
                            <button type="submit" name="ps_uid" value="{{ ps['ps_uid'] }}" class="btn btn-primary btn-sm">
                                Update
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="2"><strong>Grand Total</strong></td>
                        {% for slot in ['TIME_9AM', 'TIME_11AM', 'TIME_01PM', 'TIME_03PM', 'TIME_05PM', 'CLOSE'] %}
                            <td>{{ grand_totals[slot] | default(0) }}</td>
                            <td>{{ grand_totals_percentages[slot] | default(0) | round(2) }}%</td>
                        {% endfor %}
                        <td colspan="2"></td>
                    </tr>
                    <tr>
                        <td colspan="2"><strong>Progress %</strong></td>
                        {% for slot in ['TIME_9AM', 'TIME_11AM', 'TIME_01PM', 'TIME_03PM', 'TIME_05PM', 'CLOSE'] %}
                            <td colspan="2">{{ progress_percentages[slot] | default(0) | round(2) }}%</td>
                        {% endfor %}
                        <td colspan="2"></td>
                    </tr>
                </tfoot>
                
            </table>
        </div>
    </form>
</div>

<script>
    // Show the error modal if there's an error message from the route
    {% if error_message %}
    $(document).ready(function() {
        $('#errorModal').modal('show');
    });
    {% endif %}
</script>

</body>
</html>
